# specapp CLI (design doc, .NET-first)

The orchestrator CLI that parses multi-file specs, builds a plan, generates code/tests, and maintains a lockfile.

Technology
- Language: C# (.NET 9)
- Packaging: .NET tool (global/local)
- Parsing: Markdig (Markdown) + YamlDotNet (front matter)
- LLM (optional): OpenAI/Azure with structured function-calling for patch plans
- Codegen: T4/Scriban templates + Roslyn for syntax-aware edits
- Tests: xUnit templates, WebApplicationFactory for API, EF Core InMemory/SQLite for DB, CLI harness for console UI

Commands
- `specapp init` — scaffold directories and example specs
- `specapp plan --spec spec --out .specapp/plan.json`
  - Walk spec tree, emit normalized design model and task graph
- `specapp generate --plan .specapp/plan.json --out codegen`
  - Create or update projects, files, endpoints, DTOs, DI, EF DbContext, migrations
  - Update `.specapp/SpecLock.json`
- `specapp testgen --spec spec --out codegen/tests`
  - Parse `specapp-test`/`gherkin`/Steps into xUnit tests (model/api/db/ui/e2e)
- `specapp validate` — dotnet build, lint, test
- `specapp watch` — watch `spec/**`, regenerate to a working branch

Artifacts
- `.specapp/plan.json` — ordered tasks with dependencies
- `.specapp/SpecLock.json` — map spec-id → files with content-hash and ownership
- `.specapp/traces/*` — prompts, responses, diffs, source spec hash

Ownership and safety
- Only modify files marked owned by Specapp in the lockfile
- Generated file header: `// <auto-generated> Source: spec/<path> (id: X, hash: Y)`
- Partial classes/regions and source generators to safely compose with human code

Target adapters (MVP)
- dotnet-domain: C# class library for domain entities/services
- dotnet-webapi: ASP.NET Core minimal API
- dotnet-console: CLI with System.CommandLine
- dotnet-tests:
  - Domain tests: pure xUnit
  - API tests: WebApplicationFactory + HttpClient
  - DB tests: EFCore InMemory/SQLite
  - UI/CLI tests: harness using process or in-proc invocation
  - E2E: spin up test host and run CLI

Test mapping
- scope: model → Domain.Tests
- scope: api → Api.Tests
- scope: db → Db.Tests
- scope: ui → Console.Tests
- scope: e2e → E2E.Tests

Spec parsing notes
- YAML front matter is mandatory for stable IDs
- `refs` resolve cross-component relationships
- Tests can live next to features or under `spec/tests/**`

Open questions for future
- AuthN/Z, versioning, error catalogs
- Multi-target generation in one run (Web, Mobile, Cloud)
- Deterministic IR schema and validators
